<!DOCTYPE html>
<html>

<head>
    <title>OpenLayers Map</title>
    <link rel="stylesheet" href="ol/ol.css" type="text/css">
    <script src="ol/dist/ol.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var bounds = ol.proj.transformExtent(
            [-104.35944, 19.772676, -104.357180, 19.77638],  // [minx, miny, maxx, maxy] in EPSG:4326 (WGS 84)
            'EPSG:4326',           // Source projection
            'EPSG:3857'            // Destination projection (Web Mercator)
        );
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-104.35848, 19.77473]),
                zoom: 18,
                extent: bounds
            })
        });
        var vectorSource = new ol.source.Vector();
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });
        map.addLayer(vectorLayer);
        var currentHiddenFeature = null;
        var edificioVerticeLayer = null;
        //SHAPES GO HERE

        function addEdificio(lon, lat, nombre, image, id, pisos, v1, v2, v3, v4, tipo) {
            var edificio = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lat, lon])),
                nombre: nombre,
                pisos: pisos,
                id: id,
                v1: v1,
                v2: v2,
                v3: v3,
                v4: v4,
                tipo: tipo,
                image: image
            });

            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + image,
                    scale: 1
                })
            });

            edificio.setStyle(edificioStyle);
            vectorSource.addFeature(edificio);
            addRoomsInPolygon(v1,v2,v3,v4, 5);
        }

        function addEdificiosFromAndroid() {
            var edificios = JSON.parse(Android.getEdificios());
            edificios.forEach(function (edificio) {
                addEdificio(edificio.lon, edificio.lat, edificio.nombre, edificio.image, edificio.id, edificio.pisos, edificio.v1, edificio.v2, edificio.v3, edificio.v4);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            addEdificiosFromAndroid();
        });

        function showFeature(feature) {
            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + feature.get('image'),
                    scale: 1
                })
            });
            feature.setStyle(edificioStyle);
        }

        function hideFeature(feature) {
            feature.setStyle(new ol.style.Style({
                display: 'none'
            }));
        }

        function addRoomsInPolygon(v1,v2,v3,v4, numRooms) {
            var v11 = ol.proj.fromLonLat(v1.split(',').map(Number));
            var v22 = ol.proj.fromLonLat(v2.split(',').map(Number));
            var v33 = ol.proj.fromLonLat(v4.split(',').map(Number));
            var v44 = ol.proj.fromLonLat(v3.split(',').map(Number));

            var minX = Math.min(v11[0], v22[0], v33[0], v44[0]);
            var minY = Math.min(v11[1], v22[1], v33[1], v44[1]);
            var maxX = Math.max(v11[0], v22[0], v33[0], v44[0]);
            var maxY = Math.max(v11[1], v22[1], v33[1], v44[1]);

            var width = maxX - minX;
            var roomWidth = width / numRooms;

            var rooms = [];
            for (var i = 0; i < numRooms; i++) {
                var roomMinX = minX + i * roomWidth;
                var roomMaxX = roomMinX + roomWidth;

                var roomCoords = [
                    [roomMinX, minY],
                    [roomMaxX, minY],
                    [roomMaxX, maxY],
                    [roomMinX, maxY],
                    [roomMinX, minY]
                ];

                var roomPolygon = new ol.geom.Polygon([roomCoords]);
                var roomFeature = new ol.Feature(roomPolygon);

                var roomStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'green',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 255, 0, 0.1)'
                    })
                });
                roomFeature.setStyle(roomStyle);

                rooms.push(roomFeature);
            }

            var roomVectorSource = new ol.source.Vector({
                features: rooms
            });
            var roomLayer = new ol.layer.Vector({
                source: roomVectorSource
            });

            map.addLayer(roomLayer);

            map.getView().on('change:resolution', function () {
                var zoom = map.getView().getZoom();
                roomLayer.setVisible(zoom >= 19);
            });
        }


        function showBuildingBorders(edificio) {
            //VERTICE COORDINATES
            var vcoor = [
                ol.proj.fromLonLat(edificio.v1),
                ol.proj.fromLonLat(edificio.v2),
                ol.proj.fromLonLat(edificio.v4),
                ol.proj.fromLonLat(edificio.v3)
            ]
            console.log('Vertex coordinates:', vcoor);
            var polygon = new ol.geom.Polygon([vcoor]);
            var polygonFeature = new ol.Feature(polygon, {
                type: edificio.tipo
            });

            var polygonStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            });
            polygonFeature.setStyle(polygonStyle);

            var vectorSource = new ol.source.Vector({
                features: [polygonFeature]
            });
            edificioVerticeLayer = new ol.layer.Vector({
                source: vectorSource
            });

            // Add the vector layer to the map
            map.addLayer(edificioVerticeLayer);

        }

        map.on('click', function (event) {
            var feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            }, {
                hitTolerance: 10
            });

            if (feature && feature.get('id')) {

                var edificio = {
                    id: feature.get('id'),
                    nombre: feature.get('nombre'),
                    pisos: feature.get('pisos'),
                    v1: feature.get('v1').split(',').map(Number),
                    v2: feature.get('v2').split(',').map(Number),
                    v3: feature.get('v3').split(',').map(Number),
                    v4: feature.get('v4').split(',').map(Number),
                    tipo: feature.get('tipo'),
                    geometry: feature.getGeometry()
                };
                hideFeature(feature);
                currentHiddenFeature = feature;
                var info = feature.get('id');
                alert(info);
                showPopup(edificio);
                showBuildingBorders(edificio);
                if (typeof Android !== 'undefined' && Android.sendBuildingInfo) {
                    Android.sendBuildingInfo(info);
                }


            } else {

                hidePopup();
                if (currentHiddenFeature) {
                    showFeature(currentHiddenFeature);
                    currentHiddenFeature = null;
                }
                map.removeLayer(edificioVerticeLayer);
            };
        });
    </script>
    <style>
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            top: 10px;
            max-width: 250px;
            /* Limit maximum width */
        }

        .ol-popup-closer {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        #popup-content {
            max-height: 250px;
            /* Limit maximum height if necessary */
            text-align: center;
        }
    </style>
    <div id="popup" class="ol-popup">
        <script>
            var popup = new ol.Overlay({
                element: document.getElementById('popup'),
                autoPan: true,
                autoPanAnimation: {
                    duration: 250
                }
            });
            map.addOverlay(popup);

            // Function to show the popup with edificio information
            function showPopup(edificio) {
                var content = document.getElementById('popup-content');
                document.getElementById('edificio-nombre').textContent = edificio.nombre;

                // Handle the button click to view details
                document.getElementById('view-details-btn').onclick = function () {
                    // Handle navigation or any other action here
                    alert('View Details clicked for ' + edificio.nombre);
                    // Example: Navigate to another fragment or perform other action
                };

                popup.setPosition(edificio.geometry.getCoordinates());
                content.style.display = 'block';

            }

            // Function to hide the popup
            function hidePopup() {
                document.getElementById('popup-content').style.display = 'none';
                popup.setPosition(undefined);
            }

            // Map click event to handle feature clicks
            map.on('click', function (event) {



            });


        </script>
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content">
            <p><strong id="edificio-nombre"></strong></p>
            <button id="view-details-btn">Ver más</button>
        </div>
    </div>
</body>

</html>