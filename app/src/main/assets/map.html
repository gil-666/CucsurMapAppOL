<!DOCTYPE html>
<html>

<head>
    <title>OpenLayers Map</title>
    <link rel="stylesheet" href="ol/ol.css" type="text/css">
    <script src="ol/dist/ol.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var bounds = ol.proj.transformExtent(
            [-104.35944, 19.772676, -104.357180, 19.77638],  // [minx, miny, maxx, maxy] EPSG:4326 
            'EPSG:4326',           // source  PROJECTIONS
            'EPSG:3857'            // destination
        );
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-104.35848, 19.77473]),
                zoom: 18,
                extent: bounds
            })
        });

        //VALUES
        var roomTriggerZoom = 19;
        var vectorSource = new ol.source.Vector();
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });
        map.addLayer(vectorLayer);
        var currentHiddenFeature = null;
        var edificioVerticeLayer = null;
        var roomLayer = null;
        //SHAPES GO HERE

        var selectedFloor = 1 //SELECTED FLOOR VALUE
        function addEdificio(lon, lat, nombre, image, id, pisos, v1, v2, v3, v4, tipo) {
            var edificio = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lat, lon])),
                nombre: nombre,
                pisos: pisos,
                id: id,
                v1: v1,
                v2: v2,
                v3: v3,
                v4: v4,
                tipo: tipo,
                image: image
            });

            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + image,
                    scale: 1
                })
            });

            edificio.setStyle(edificioStyle);
            vectorSource.addFeature(edificio);
            var salones = JSON.parse(Android.getEdificioSalones(edificio.get('id')));
            console.log("salones: ", salones)

            addRoomsInPolygon(edificio, salones, selectedFloor);
        }

        function addEdificiosFromAndroid() {
            var edificios = JSON.parse(Android.getEdificios());
            edificios.forEach(function (edificio) {
                addEdificio(edificio.lon, edificio.lat, edificio.nombre, edificio.image, edificio.id, edificio.pisos, edificio.v1, edificio.v2, edificio.v3, edificio.v4, edificio.tipo);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            addEdificiosFromAndroid();
        });

        function showFeature(feature) {
            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + feature.get('image'),
                    scale: 1
                })
            });
            feature.setStyle(edificioStyle);
        }

        function hideFeature(feature) {
            feature.setStyle(new ol.style.Style({
                display: 'none'
            }));
        }

        function addRoomsInPolygon(edificio, salones, selectedFloor) {
            var v11 = ol.proj.fromLonLat(edificio.get('v1').split(',').map(Number));
            var v22 = ol.proj.fromLonLat(edificio.get('v2').split(',').map(Number));
            var v33 = ol.proj.fromLonLat(edificio.get('v3').split(',').map(Number));
            var v44 = ol.proj.fromLonLat(edificio.get('v4').split(',').map(Number));

            var minX = Math.min(v11[0], v22[0], v33[0], v44[0]);
            var minY = Math.min(v11[1], v22[1], v33[1], v44[1]);
            var maxX = Math.max(v11[0], v22[0], v33[0], v44[0]);
            var maxY = Math.max(v11[1], v22[1], v33[1], v44[1]);

            var viewableRooms = []
            for (var i = 0; i < Object.keys(salones).length; i++) {
                if (salones[i].piso == selectedFloor) {
                    viewableRooms.push(salones[i])
                }
            }
            var width = maxX - minX;
            var roomWidth = width / Object.keys(viewableRooms).length;

            var rooms = [];
            for (var i = 0; i < Object.keys(viewableRooms).length; i++) {
                var roomMinX = minX - i * roomWidth + width;
                var roomMaxX = roomMinX - roomWidth;

                var roomCoords = [
                    [roomMinX, minY],
                    [roomMaxX, minY],
                    [roomMaxX, maxY],
                    [roomMinX, maxY],
                    [roomMinX, minY]
                ];

                var roomPolygon = new ol.geom.Polygon([roomCoords]);
                var roomFeature = new ol.Feature({
                    geometry: roomPolygon,
                    salonid: viewableRooms[i].salonid,
                    nombre: viewableRooms[i].nombre,
                    tipo: viewableRooms[i].tipo,
                    piso: viewableRooms[i].piso
                });

                var officeStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'magenta',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 255, 0.1)'
                    }),
                    text: new ol.style.Text({
                        text: roomFeature.get('nombre'),
                        font: '16px Calibri,sans-serif',
                        fill: new ol.style.Fill({
                            color: '#000'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 2
                        })
                    })
                });

                var roomStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'green',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 255, 0, 0.1)'
                    }),
                    text: new ol.style.Text({
                        text: roomFeature.get('nombre'),
                        font: '16px Calibri,sans-serif',
                        fill: new ol.style.Fill({
                            color: '#000'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 2
                        })
                    })
                });
                if (roomFeature.get('tipo') == "salon") {
                    roomFeature.setStyle(roomStyle);
                } else if (roomFeature.get('tipo') == "oficina") {
                    roomFeature.setStyle(officeStyle);
                }


                rooms.push(roomFeature);
            }

            console.log("pushed viewable", viewableRooms)
            var roomVectorSource = new ol.source.Vector({
                features: rooms
            });
            roomLayer = new ol.layer.Vector({
                source: roomVectorSource
            });

            map.addLayer(roomLayer);
            roomLayer.setVisible(0);



            map.getView().on('change:resolution', function () {
                var zoom = map.getView().getZoom();
                roomLayer.setVisible(zoom >= roomTriggerZoom);
                if (zoom < roomTriggerZoom) {
                    vectorLayer.setVisible(1);
                } else {
                    vectorLayer.setVisible(0);
                }

            });

        }


        function showBuildingBorders(edificio) {
            //VERTICE COORDINATES
            var vcoor = [
                ol.proj.fromLonLat(edificio.v1),
                ol.proj.fromLonLat(edificio.v2),
                ol.proj.fromLonLat(edificio.v3),
                ol.proj.fromLonLat(edificio.v4)
            ]
            console.log('Vertex coordinates:', vcoor);
            var polygon = new ol.geom.Polygon([vcoor]);
            var polygonFeature = new ol.Feature(polygon, {
                tipo: edificio.tipo
            });

            var polygonStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            });
            polygonFeature.setStyle(polygonStyle);

            var vectorSource = new ol.source.Vector({
                features: [polygonFeature]
            });
            edificioVerticeLayer = new ol.layer.Vector({
                source: vectorSource
            });

            // Add the vector layer to the map
            map.addLayer(edificioVerticeLayer);

        }

        function featureDetailsToString(feature) {
            var details = "feature not clicked"
            if (feature) {
                var properties = feature.getProperties();
                details = `Feature Details:\n`;

                for (var key in properties) {
                    if (properties.hasOwnProperty(key)) {
                        details += `${key}: ${properties[key]}\n`;
                    }
                }
            }


            return details;
        }

        map.on('click', function (event) {
            var feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            }, {
                hitTolerance: 10
            });

            console.log(featureDetailsToString(feature))
            if(feature && currentHiddenFeature != null){
                showFeature(currentHiddenFeature);
                map.removeLayer(edificioVerticeLayer);
            }

            if (feature && feature.get('id')) {

                var edificio = {
                    id: feature.get('id'),
                    nombre: feature.get('nombre'),
                    pisos: feature.get('pisos'),
                    v1: feature.get('v1').split(',').map(Number),
                    v2: feature.get('v2').split(',').map(Number),
                    v3: feature.get('v3').split(',').map(Number),
                    v4: feature.get('v4').split(',').map(Number),
                    tipo: feature.get('tipo'),
                    geometry: feature.getGeometry()
                };
                hideFeature(feature);
                
                currentHiddenFeature = feature;
                var info = feature.get('id');
                alert(info);
                showPopup(feature);
                showBuildingBorders(edificio);
                if (typeof Android !== 'undefined' && Android.sendBuildingInfo) {
                    Android.sendBuildingInfo(info);
                }


            }
            else if (feature && feature.get('salonid')) {
                var salon = {
                    id: feature.get('salonid')
                }
                var info = feature.get('salonid');
                if (typeof Android !== 'undefined' && Android.sendBuildingInfo) {
                    Android.sendBuildingInfo(info);
                }
            }
            else {

                hidePopup();
                if (currentHiddenFeature) {
                    showFeature(currentHiddenFeature);
                    currentHiddenFeature = null;
                }
                map.removeLayer(edificioVerticeLayer);
            };
        });

        function getAllFeaturesToArray() {
            var featuresSource = vectorSource.getFeatures();
            var features = [];
            featuresSource.forEach(function (sourceFeature) {
                features.push(sourceFeature);
            });
            return features;
        };

        function hideAllFeatures() {
            var featuresSource = vectorSource.getFeatures();
            featuresSource.forEach(function (sourceFeature) {
                hideFeature(sourceFeature);
            });
        }

        function showAllFeatures() {
            var featuresSource = vectorSource.getFeatures();
            featuresSource.forEach(function (sourceFeature) {
                showFeature(sourceFeature);
            });
        }

    </script>
    <style>
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            top: 10px;
            max-width: 250px;
            /* Limit maximum width */
        }

        .ol-popup-closer {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        #popup-content {
            max-height: 250px;
            /* Limit maximum height if necessary */
            text-align: center;
        }
    </style>
    <div id="popup" class="ol-popup">
        <script>
            var popup = new ol.Overlay({
                element: document.getElementById('popup'),
                autoPan: true,
                autoPanAnimation: {
                    duration: 250
                }
            });
            map.addOverlay(popup);
            function showPopup(feature) {
                var content = document.getElementById('popup-content');
                document.getElementById('edificio-nombre').textContent = feature.get('nombre');
                document.getElementById('view-details-btn').onclick = function () {
                    alert('View Details clicked for ' + feature.get('nombre'));
                    hidePopup();
                    map.removeLayer(edificioVerticeLayer);

                    var ext = currentHiddenFeature.getGeometry().getExtent();
                    var center = ol.extent.getCenter(ext);

                    var view = map.getView();
                    view.animate({
                        projection: 'EPSG:3857',//or any projection you are using
                        center: [center[0], center[1]],//zoom to the center of your feature
                        zoom: 19.5, 
                        duration: 1000,
                        extent: bounds
                    });
                    roomLayer.setVisible(1); //force rooms to show on zoom
                    vectorLayer.setVisible(0);


                    //force hide edificio icon
                    map.getView().on('change:resolution', function () {
                        var zoom = map.getView().getZoom();
                        roomLayer.setVisible(zoom >= roomTriggerZoom);
                        if (zoom < roomTriggerZoom) {
                            vectorLayer.setVisible(1);
                        } else {
                            vectorLayer.setVisible(0);
                        }

                    });

                    if (currentHiddenFeature) {
                        showFeature(currentHiddenFeature);
                        currentHiddenFeature = null;
                    }
                };

                popup.setPosition(feature.get('geometry').getCoordinates());
                content.style.display = 'block';

            }

            // Function to hide the popup
            function hidePopup() {
                document.getElementById('popup-content').style.display = 'none';
                popup.setPosition(undefined);
            }

            // Map click event to handle feature clicks



        </script>
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content">
            <p><strong id="edificio-nombre"></strong></p>
            <button id="view-details-btn">Ver más</button>
        </div>
    </div>
</body>

</html>