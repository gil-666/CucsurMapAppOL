<!DOCTYPE html>
<html>

<head>
    <title>OpenLayers Map</title>
    <link rel="stylesheet" href="ol/ol.css" type="text/css">
    <script src="ol/dist/ol.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: relative;
            z-index: 0;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
        }

        .wrapper {
            width: 100%;
            max-width: 80%;
            align-content: center;
            align-self: center;
            align-items: center;

            position: absolute;
            top: 40px;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;

        }

        .label {
            font-size: .625rem;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: +1.3px;
            margin-bottom: 1rem;
        }

        .searchBar {
            width: 100%;
            display: flex;
            flex-direction: row;


        }

        #searchQueryInput {
            width: 100%;
            height: 2.8rem;
            background: #f5f5f5;
            outline: none;
            border: none;
            border-radius: 1.625rem;
            padding: 0 3.5rem 0 1.5rem;
            font-size: 1rem;
            box-shadow: 0px 0px 10px black;
        }

        #searchQuerySubmit {
            width: 3.5rem;
            height: 2.8rem;
            margin-left: -3.5rem;
            background: none;
            border: none;
            outline: none;
        }

        #searchQuerySubmit:hover {
            cursor: pointer;
        }

        .ol-zoom {
            position: absolute;
            top: 80px;
        }

        .ol-zoom-in:hover,
        .ol-zoom-out:hover {
            background-color: white !important;
            /* White background on hover */
            color: black !important;
            /* Black text on hover */
        }


        .ol-rotate {
            position: absolute;
            top: 80px;
        }
    </style>

</head>

<body>
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">

    <div class="wrapper">
        <div class="searchBar">
            <input id="searchQueryInput" type="text" name="searchQueryInput" placeholder="Buscar un edificio o salón..."
                value="" />
            <button id="searchQuerySubmit" type="submit" name="searchQuerySubmit">
                <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                    <path fill="#666666"
                        d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
                </svg>
            </button>
        </div>
    </div>
    <div id="map">

    </div>
    <script>
        var bounds = ol.proj.transformExtent(
            [-104.35944, 19.772676, -104.357180, 19.77638],  // [minx, miny, maxx, maxy] EPSG:4326 
            'EPSG:4326',           // source  PROJECTIONS
            'EPSG:3857'            // destination
        );
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([-104.35848, 19.77473]),
                zoom: 18.3,
                extent: bounds
            })
        });

        //VALUES
        var roomTriggerZoom = 19;
        var vectorSource = new ol.source.Vector();
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource
        });

        var arrowControlSource = new ol.source.Vector();
        var arrowLayer = new ol.layer.Vector({
            source: arrowControlSource
        });
        map.addLayer(vectorLayer);
        var currentHiddenFeature = null;
        var edificioVerticeLayer = null;

        var roomVectorSource = null;
        var roomLayer = null;
        var rooms = [];
        //SHAPES GO HERE

        var selectedFloor = 1 //SELECTED FLOOR VALUE
        function addEdificio(lon, lat, nombre, image, id, pisos, v1, v2, v3, v4, tipo) {
            var salones = JSON.parse(Android.getEdificioSalones(id));
            var edificio = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lat, lon])),
                nombre: nombre,
                pisos: pisos,
                id: id,
                v1: v1,
                v2: v2,
                v3: v3,
                v4: v4,
                tipo: tipo,
                image: image,
                salones: salones
            });

            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + image,
                    scale: 1
                })
            });

            edificio.setStyle(edificioStyle);
            vectorSource.addFeature(edificio);
            console.log("salones: ", salones)

            addRoomsInPolygon(edificio, salones, selectedFloor);
            drawBuildingStoryControl(edificio);
        }

        function addEdificiosFromAndroid() {
            var edificios = JSON.parse(Android.getEdificios());
            edificios.forEach(function (edificio) {
                addEdificio(edificio.lon, edificio.lat, edificio.nombre, edificio.image, edificio.id, edificio.pisos, edificio.v1, edificio.v2, edificio.v3, edificio.v4, edificio.tipo);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            addEdificiosFromAndroid();
        });

        function showFeature(feature) {
            var edificioStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'data:image/png;base64,' + feature.get('image'),
                    scale: 1
                })
            });
            feature.setStyle(edificioStyle);
        }

        function hideFeature(feature) {
            feature.setStyle(new ol.style.Style({
                display: 'none'
            }));
        }

        function addRoomsInPolygon(edificio, salones, selectedFloor) {
            var v11 = ol.proj.fromLonLat(edificio.get('v1').split(',').map(Number));
            var v22 = ol.proj.fromLonLat(edificio.get('v2').split(',').map(Number));
            var v33 = ol.proj.fromLonLat(edificio.get('v3').split(',').map(Number));
            var v44 = ol.proj.fromLonLat(edificio.get('v4').split(',').map(Number));

            var minX = Math.min(v11[0], v22[0], v33[0], v44[0]);
            var minY = Math.min(v11[1], v22[1], v33[1], v44[1]);
            var maxX = Math.max(v11[0], v22[0], v33[0], v44[0]);
            var maxY = Math.max(v11[1], v22[1], v33[1], v44[1]);

            var viewableRooms = []
            for (var i = 0; i < Object.keys(salones).length; i++) {
                if (salones[i].piso == selectedFloor) {
                    viewableRooms.push(salones[i])
                }
            }
            var width = maxX - minX;
            var roomWidth = width / Object.keys(viewableRooms).length;


            for (var i = 0; i < Object.keys(viewableRooms).length; i++) {
                var roomMinX = minX - i * roomWidth + width;
                var roomMaxX = roomMinX - roomWidth;

                var roomCoords = [
                    [roomMinX, minY],
                    [roomMaxX, minY],
                    [roomMaxX, maxY],
                    [roomMinX, maxY],
                    [roomMinX, minY]
                ];

                var roomPolygon = new ol.geom.Polygon([roomCoords]);
                var roomFeature = new ol.Feature({
                    geometry: roomPolygon,
                    salonid: viewableRooms[i].salonid,
                    nombre: viewableRooms[i].nombre,
                    tipo: viewableRooms[i].tipo,
                    piso: viewableRooms[i].piso,
                    edificioid: viewableRooms[i].edificio_edificioid
                });

                var officeStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'magenta',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 255, 0.1)'
                    }),
                    text: new ol.style.Text({
                        text: roomFeature.get('nombre'),
                        font: '16px Calibri,sans-serif',
                        fill: new ol.style.Fill({
                            color: '#000'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 2
                        })
                    })
                });

                var roomStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'green',
                        width: 1
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 255, 0, 0.1)'
                    }),
                    text: new ol.style.Text({
                        text: roomFeature.get('nombre'),
                        font: '16px Calibri,sans-serif',
                        fill: new ol.style.Fill({
                            color: '#000'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 2
                        })
                    })
                });
                if (roomFeature.get('tipo') == "salon") {
                    roomFeature.setStyle(roomStyle);
                } else if (roomFeature.get('tipo') == "oficina") {
                    roomFeature.setStyle(officeStyle);
                }


                rooms.push(roomFeature);
            }

            console.log("pushed viewable", viewableRooms)
            roomVectorSource = new ol.source.Vector({
                features: rooms
            });
            roomLayer = new ol.layer.Vector({
                source: roomVectorSource
            });

            map.addLayer(roomLayer);
            roomLayer.setVisible(0);



            map.getView().on('change:resolution', function () {
                var zoom = map.getView().getZoom();
                roomLayer.setVisible(zoom >= roomTriggerZoom);
                if (zoom < roomTriggerZoom) {
                    vectorLayer.setVisible(1);
                    arrowLayer.setVisible(0);
                } else {
                    vectorLayer.setVisible(0);
                    arrowLayer.setVisible(1);
                }

            });

        }

        function drawBuildingStoryControl(edificio) {
            var v1 = ol.proj.fromLonLat(edificio.get('v1').split(',').map(Number));
            var v2 = ol.proj.fromLonLat(edificio.get('v2').split(',').map(Number));
            var v3 = ol.proj.fromLonLat(edificio.get('v3').split(',').map(Number));
            var v4 = ol.proj.fromLonLat(edificio.get('v4').split(',').map(Number));

            var topY = Math.max(v1[1], v2[1], v3[1], v4[1]);
            var bottomY = Math.min(v1[1], v2[1], v3[1], v4[1]);
            var midX = (v1[0] + v2[0] + v3[0] + v4[0]) / 4;

            var arrowUpPosition = [midX, topY + 0.0001];
            var arrowDownPosition = [midX, bottomY - 0.0001];

            var upArrowFeature = new ol.Feature({
                geometry: new ol.geom.Point(arrowUpPosition),
                tipo: "uparrow",
                edificio: edificio,

            })

            var downArrowFeature = new ol.Feature({
                geometry: new ol.geom.Point(arrowDownPosition),
                tipo: "downarrow",
                edificio: edificio,

            });

            var upArrowStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'images/up_arrow.png',
                    scale: 0.8
                })
            });

            var downArrowStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 0],
                    src: 'images/down_arrow.png',
                    scale: 0.8
                })
            });

            upArrowFeature.setStyle(upArrowStyle);
            downArrowFeature.setStyle(downArrowStyle);
            if (edificio.get('pisos') > 1) { //si el edificio tiene mas de 1 piso, agrega las flechas
                // si solo tiene un piso no son necesarias las flechas
                arrowControlSource.addFeature(upArrowFeature);
                arrowControlSource.addFeature(downArrowFeature);
            }

            map.addLayer(arrowLayer);
            arrowLayer.setVisible(0);
        }

        function showBuildingBorders(edificio) {
            //VERTICE COORDINATES
            var vcoor = [
                ol.proj.fromLonLat(edificio.v1),
                ol.proj.fromLonLat(edificio.v2),
                ol.proj.fromLonLat(edificio.v3),
                ol.proj.fromLonLat(edificio.v4)
            ]
            console.log('Vertex coordinates:', vcoor);
            var polygon = new ol.geom.Polygon([vcoor]);
            var polygonFeature = new ol.Feature(polygon, {
                tipo: edificio.tipo
            });

            var polygonStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            });
            polygonFeature.setStyle(polygonStyle);

            var vectorSource = new ol.source.Vector({
                features: [polygonFeature]
            });
            edificioVerticeLayer = new ol.layer.Vector({
                source: vectorSource
            });

            // Add the vector layer to the map
            map.addLayer(edificioVerticeLayer);

        }

        function featureDetailsToString(feature) {
            var details = "feature not clicked"
            if (feature) {
                var properties = feature.getProperties();
                details = `Feature Details:\n`;

                for (var key in properties) {
                    if (properties.hasOwnProperty(key)) {
                        details += `${key}: ${properties[key]}\n`;
                    }
                }
            }


            return details;
        }

        map.on('click', function (event) {
            var feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            }, {
                hitTolerance: 10
            });

            console.log(featureDetailsToString(feature))
            if (feature && currentHiddenFeature != null) {
                showFeature(currentHiddenFeature);
                map.removeLayer(edificioVerticeLayer);
            }

            if (feature && feature.get('id')) {

                var edificio = {
                    id: feature.get('id'),
                    nombre: feature.get('nombre'),
                    pisos: feature.get('pisos'),
                    v1: feature.get('v1').split(',').map(Number),
                    v2: feature.get('v2').split(',').map(Number),
                    v3: feature.get('v3').split(',').map(Number),
                    v4: feature.get('v4').split(',').map(Number),
                    tipo: feature.get('tipo'),
                    geometry: feature.getGeometry()
                };
                hideFeature(feature);

                currentHiddenFeature = feature;
                var info = feature.get('id');
                alert(info);
                showPopup(feature);
                showBuildingBorders(edificio);
                if (typeof Android !== 'undefined' && Android.sendBuildingInfo) {
                    Android.sendBuildingInfo(info);
                }


            }
            else if (feature && feature.get('salonid')) {
                var salon = {
                    id: feature.get('salonid')
                }
                var info = feature.get('salonid');
                // showPopup(feature);
                if (typeof Android !== 'undefined' && Android.sendBuildingInfo) {
                    Android.sendBuildingInfo(info);
                }
            } else if (feature && feature.get('tipo') == "uparrow") {
                for (var i = rooms.length - 1; i >= 0; i--) {
                    if (rooms[i].get('piso') == selectedFloor && rooms[i].get('edificioid') == feature.get('edificio').get('id')) {
                        console.log("removed room: ", rooms[i].get('nombre'));
                        rooms.splice(i, 1); // Removing index i

                    }
                }
                map.removeLayer(roomLayer);
                if (selectedFloor >= 1 && selectedFloor <= feature.get('edificio').get('pisos') - 1) {
                    selectedFloor++;
                }

                console.log("floor select: ", selectedFloor);

                addRoomsInPolygon(feature.get('edificio'), feature.get('edificio').get('salones'), selectedFloor);
                roomLayer.setVisible(1);
            } else if (feature && feature.get('tipo') == "downarrow") {
                for (var i = rooms.length - 1; i >= 0; i--) {
                    if (rooms[i].get('piso') == selectedFloor && rooms[i].get('edificioid') == feature.get('edificio').get('id')) {
                        console.log("removed room: ", rooms[i].get('nombre'));
                        rooms.splice(i, 1); // Removing index i

                    }
                }
                map.removeLayer(roomLayer);
                if (selectedFloor > 1) {
                    selectedFloor--;
                }

                console.log("floor select: ", selectedFloor);

                addRoomsInPolygon(feature.get('edificio'), feature.get('edificio').get('salones'), selectedFloor);
                roomLayer.setVisible(1);
            }
            else {

                hidePopup();
                if (currentHiddenFeature) {
                    showFeature(currentHiddenFeature);
                    currentHiddenFeature = null;
                }
                map.removeLayer(edificioVerticeLayer);
            };
        });

        function getAllFeaturesToArray() {
            var featuresSource = vectorSource.getFeatures();
            var features = [];
            featuresSource.forEach(function (sourceFeature) {
                features.push(sourceFeature);
            });
            return features;
        };

        function hideAllFeatures() {
            var featuresSource = vectorSource.getFeatures();
            featuresSource.forEach(function (sourceFeature) {
                hideFeature(sourceFeature);
            });
        }

        function showAllFeatures() {
            var featuresSource = vectorSource.getFeatures();
            featuresSource.forEach(function (sourceFeature) {
                showFeature(sourceFeature);
            });
        }

    </script>
    <style>
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            top: 10px;
            max-width: 250px;
            /* Limit maximum width */
        }

        .ol-popup-closer {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        #popup-content {
            max-height: 250px;
            /* Limit maximum height if necessary */
            text-align: center;
        }
    </style>
    <div id="popup" class="ol-popup">
        <script>
            var popup = new ol.Overlay({
                element: document.getElementById('popup'),
                autoPan: true,
                autoPanAnimation: {
                    duration: 250
                }
            });
            map.addOverlay(popup);
            function showPopup(feature) {
                var content = document.getElementById('popup-content');
                document.getElementById('edificio-nombre').textContent = feature.get('nombre');
                document.getElementById('view-details-btn').onclick = function () {
                    alert('View Details clicked for ' + feature.get('nombre'));
                    hidePopup();
                    map.removeLayer(edificioVerticeLayer);

                    var ext = currentHiddenFeature.getGeometry().getExtent();
                    var center = ol.extent.getCenter(ext);

                    var view = map.getView();
                    view.animate({
                        projection: 'EPSG:3857',//or any projection you are using
                        center: [center[0], center[1]],//zoom to the center of your feature
                        zoom: 19.5,
                        duration: 1000,
                        extent: bounds
                    });
                    roomLayer.setVisible(1); //force rooms to show on zoom
                    vectorLayer.setVisible(0);


                    //force hide edificio icon
                    map.getView().on('change:resolution', function () {
                        var zoom = map.getView().getZoom();
                        roomLayer.setVisible(zoom >= roomTriggerZoom);
                        if (zoom < roomTriggerZoom) {
                            vectorLayer.setVisible(1);
                            arrowLayer.setVisible(0);
                        } else {
                            vectorLayer.setVisible(0);
                            arrowLayer.setVisible(1);
                        }

                    });

                    if (currentHiddenFeature) {
                        showFeature(currentHiddenFeature);
                        currentHiddenFeature = null;
                    }
                };

                popup.setPosition(feature.get('geometry').getCoordinates());
                content.style.display = 'block';

            }

            // Function to hide the popup
            function hidePopup() {
                document.getElementById('popup-content').style.display = 'none';
                popup.setPosition(undefined);
            }

            // Map click event to handle feature clicks



        </script>

        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content">
            <p><strong id="edificio-nombre"></strong></p>
            <button id="view-details-btn">Ver más</button>
        </div>
    </div>
</body>

</html>